# Anonymous User Fingerprint Limit

## Overview

Anonymous users (not logged in) can only create **1 short URL per browser fingerprint**. This prevents abuse while still allowing users to try the service before registering.

**Why fingerprints instead of IP addresses?**
- IP addresses were unreliable because requests from WordPress API returned the server's IP, not the user's
- IP-based limits restricted entire networks (e.g., an office could only create 1 link total)
- Browser fingerprints uniquely identify individual browsers, even on shared networks

## How It Works

1. Frontend generates a browser fingerprint using [FingerprintJS](https://github.com/fingerprintjs/fingerprintjs)
2. When creating a short URL with `uid: -1` (anonymous), the fingerprint is sent in the request body
3. The fingerprint is stored in `tp_map.created_by_fingerprint` column
4. On subsequent create attempts, the backend checks if that fingerprint already has an anonymous URL
5. If yes, returns `429` error

## API Behavior

### Create Short URL (Anonymous)

**Endpoint:** `POST /items/`

**Request Body:**
```json
{
  "uid": -1,
  "domain": "dev.trfc.link",
  "tpKey": "mylink",
  "destination": "https://example.com",
  "type": "url",
  "is_set": 0,
  "status": "active",
  "tags": "",
  "notes": "",
  "settings": "",
  "fingerprint": "a1b2c3d4e5f6..."
}
```

**Fingerprint field:**
- Type: string (hex)
- Length: 32-64 characters
- Pattern: `^[a-fA-F0-9]{32,64}$`
- Generated by FingerprintJS `visitorId`

### Success Response (First URL)

**Status:** `200`

```json
{
  "message": "Record Created",
  "source": {
    "mid": 14205,
    "uid": -1,
    "tpKey": "mylink",
    "destination": "https://example.com",
    ...
  },
  "success": true
}
```

### Error Response (Limit Reached)

**Status:** `429`

```json
{
  "message": "Anonymous users can only create 1 short URL. Please register for unlimited URLs.",
  "source": null,
  "success": false
}
```

## Frontend Implementation

### 1. Install FingerprintJS

```bash
npm install @fingerprintjs/fingerprintjs
```

### 2. Generate Fingerprint and Create URL

```javascript
import FingerprintJS from '@fingerprintjs/fingerprintjs';

async function createShortUrl(data) {
  // Get browser fingerprint
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  const fingerprint = result.visitorId;

  // Add fingerprint to request
  const payload = {
    ...data,
    fingerprint: fingerprint
  };

  const response = await fetch('/items/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const result = await response.json();

  if (response.status === 429) {
    // Show registration prompt
    showRegistrationModal({
      message: result.message,
      pendingUrl: data.destination
    });
    return;
  }

  if (!result.success) {
    showError(result.message);
    return;
  }

  // Success - show the created short URL
  showSuccess(result.source);
}
```

### 3. Search for User's Existing Link

If you want to show users their existing anonymous link:

```javascript
async function findMyLink() {
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  const fingerprint = result.visitorId;

  const response = await fetch(`/items/by-fingerprint/${fingerprint}`);
  const data = await response.json();

  if (data.success && data.source.count > 0) {
    // User has an existing link
    return data.source.records[0];
  }
  return null;
}
```

### UX Recommendations

1. **Before creation**: Check if user already has an anonymous URL using the search endpoint
2. **On 429 error**: Show a friendly modal encouraging registration with benefits:
   - Unlimited short URLs
   - Analytics and tracking
   - Custom domains
   - URL management
3. **Preserve intent**: Save their attempted URL so they can create it after registering

### Example UI Flow

```
[User enters URL]
    → [Generate fingerprint]
    → [Click Create]
    → [API returns 429]
    → [Show modal: "You've used your free link! Register for unlimited URLs"]
    → [Register button] / [Login button]
```

## Database Schema

```sql
-- Column in tp_map
created_by_fingerprint VARCHAR(64) NULL

-- Indexes
idx_created_by_fingerprint (created_by_fingerprint)
idx_anon_fingerprint_lookup (uid, created_by_fingerprint)
```

## Notes

- Fingerprint is generated client-side using FingerprintJS
- Only stored for anonymous users (`uid = -1`), NULL for registered users
- Registered users (`uid > 0`) are not affected - they have unlimited URLs
- Fingerprints are more reliable than IPs for identifying unique browsers
- Users on the same network (e.g., office) can each create their own link
